name: Armbian Compile and Release
on:
  workflow_dispatch:
env:
  RELEASE_BRANCH: "current"
concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true
jobs:
  build:
    name: "Build Armbian"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Compile
        run: |
         export DESKTOP_ENVIRONMENT="xfce"
          ./compile.sh \
            BOARD=rk3318-box \
            BRANCH=${{ env.RELEASE_BRANCH }} \
            RELEASE=jammy \
            BSPFREEZE=no \
            BUILD_MINIMAL=no \
            BUILD_DESKTOP=yes \
            DESKTOP_ENVIRONMENT=xfce \
            DESKTOP_ENVIRONMENT_CONFIG_NAME=config_base \
            DESKTOP_APPGROUPS_SELECTED="browsers, desktop_tools, editor, internet, multimedia, programming" \
            KERNEL_CONFIGURE=no \
            EXTRAWIFI=yes \
            INSTALL_HEADERS=yes \
            VENDOR=Armbian \
            COMPRESS_OUTPUTIMAGE=xz
      - name: Get image filename
        id: get-filename
        run: echo "filename=$(basename $(ls output/images/*.img.xz) .img.xz)" >> $GITHUB_OUTPUT
      - name: Release
        id: create_release
        uses: ncipollo/release-action@main
        with:
          prerelease: true
          allowUpdates: true
          name: ${{ github.ref_name }}-${{ steps.get-filename.outputs.filename }}
          artifacts: output/images/${{ steps.get-filename.outputs.filename }}.img.xz, output/images/${{ steps.get-filename.outputs.filename }}.img.txt
